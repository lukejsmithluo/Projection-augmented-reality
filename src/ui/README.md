# 用户界面（ui）

此目录包含 PyQt6 应用入口与基础窗口：
- `app.py`：主窗口，包含“空间映射”、“投影标定”、“AI图像生成”标签页。

运行示例：
```powershell
python .\src\ui\app.py
```

使用说明：
- 先启动后端 API 服务：`python -m uvicorn src.server.main:app --reload`。
- UI 按钮通过 HTTP 调用后端端点：
  - “开始映射/停止映射”分别对应 `POST /mapping/start` 与 `POST /mapping/stop`；
  - “开始标定”对应 `POST /calibration/run`；状态信息将在标签页标题处更新。
  - “AI图像生成”上传图片与提示词，调用 `POST /ai-image/edit`，输出路径显示在状态区域；支持按模型选择提供者（Gemini/OpenAI），并通过界面输入对应的 API Key（无需预置 `.env`）。
- 生成成功后 UI 内直接预览图片，并提供“打开输出目录”按钮快捷查看生成结果文件。
  - 支持“预览最新输出”，无需再次生成，直接显示 `data/ai_images/outputs` 中最近的图片。
  - 支持多图选择并在界面中进行右到左缩略图排布；生成默认使用最近一次选择的图片。
  - 缩略图预览置于 16:9 框中（约 640x360），一次最多可见 3 张，更多图片可通过横向滑条浏览；顺序为左→右：最早在左、最新在右；提供“清空已选图片”按钮。
  - 选择数量限制：按模型自动限制可选图片数量并在超限时提示（同时后端也会强制校验）：
    - OpenAI（`gpt-image-1`）：最多 1 张；
    - Gemini 3 Pro Image（`gemini-3-pro-image-preview`）：最多 14 张；
    - Gemini 2.5（含 `gemini-2.5-flash-image`）与其他 Gemini/Imagen：默认最多 16 张；
    超过上限时 UI 会提示并仅保留最新的若干张，后端超限返回统一错误 `TOO_MANY_IMAGES`。
  - 生成界面新增 API Key 输入框（默认以 * 隐藏，右侧按钮可切换显示）；当填写时会随请求一并传递到后端按提供者即时使用（Gemini 使用 `GEMINI_API_KEY`，OpenAI 使用 `OPENAI_API_KEY`）。
  - 新增模型下拉选择（默认 `gemini-2.5-flash-image`），随选择自动推断提供者并传递 `provider=gemini|openai`；保留 `OpenAI Org ID` 输入框用于 OpenAI 指定组织。
  - 模型下拉包含图像生成模型：`gemini-2.5-flash-image`（默认）、`gemini-3-pro-image-preview` 与 `gpt-image-1`；聊天/文本模型不适用于图像编辑接口。
  - 模型联动输入：
    - 当选择 `gpt-image-1`（OpenAI），显示尺寸文本框，仅允许 `256x256`/`512x512`/`1024x1024`；输入错误将提示“尺寸仅支持 256x256 / 512x512 / 1024x1024”。
    - 当选择 Gemini 模型（`gemini-*`/`imagen-*`），显示宽高比与分辨率下拉：宽高比允许 `1:1, 2:3, 3:2, 3:4, 4:3, 4:5, 5:4, 9:16, 16:9, 21:9`；分辨率允许 `1K/2K/4K`（大写 K）；输入错误将提示“Aspect Ratio 仅支持列表中的选项”或“Resolution 仅支持 1K/2K/4K（大写K）”。
  - 新增“地区状态”信息展示与刷新按钮：通过 `GET /policy/region/status` 显示国家/地区代码、城市、是否允许、连通性诊断与原因；地区策略按提供者使用对应白名单（Gemini/OpenAI），VPN 以出口 IP 定位为准。
 - API 基础地址可通过环境变量配置：`API_BASE_URL`（默认 `http://127.0.0.1:8000`）。
 - 为避免 VPN/系统代理拦截本地请求，UI 在所有对后端的 HTTP 请求中已显式禁用代理（`requests` 参数 `proxies={"http": None, "https": None}`）；这不会绕过后端的地区策略判断，仅保证 UI 请求能直接连接到本地服务。
- 文本选择与复制：所有状态标签（映射/标定/AI 图像）均支持文本文字选择与复制；AI 图像页额外提供“复制状态”“复制地区状态”按钮，方便在出现错误时快速复制文本内容。

窗口尺寸：默认 `1280x720`（16:9）。

预览与选择控件：
- 输出与选择预览均采用 16:9 窗口，横向自适应当前窗口宽度并居中摆放；整个标签页四周保留 24px 安全区，避免与其他控件贴近。图片按比例缩放填充，不会拉伸变形。
- 已选图片预览区域（16:9 框内横向滚动）支持内联操作：
  - 左侧“×”清空所有已选图片（替代底部清空按钮）。
  - 右侧末尾“＋”用于添加图片（替代底部选择按钮），添加后“＋”始终在最右侧。
  - 每张预览图右上角“－”用于移除该图片。

更新记录：
- 2025-11-21：AI 图像页按模型限制图片选择数量（OpenAI=1；Gemini-3-Pro-Image-Preview=14；Gemini-2.5=16），超限时 UI 友好提示并仅保留最新的若干张；生成前加一道上限校验避免误操作导致的请求超限。
- 2025-11-21：AI 图像页改造预览与选择交互：输出预览固定 16:9；预览窗口左侧新增“×”清空；每张预览图右上角新增“－”移除；右端保留“＋”添加并始终位于最右；移除底部“选择/清空”按钮，统一用内联控件操作。
- 2025-11-21：预览窗口横向自适应并居中摆放；为标签页四周加入 24px 安全区，避免控件贴近，提升观感与操作舒适度。
- 2025-11-21：AI 图像页新增 Gemini 3 Pro Image 模型（`gemini-3-pro-image-preview`），并按模型联动输入控件（OpenAI：尺寸；Gemini：宽高比/分辨率）；后端同步支持 `aspect_ratio` 与 `image_resolution` 字段的校验与传递。
- 2025-11-21：模型默认改为 `gemini-2.5-flash-image`；新增按提供者使用的 API Key 输入与 `provider` 自动传递；与后端联动地区白名单（Gemini/OpenAI）。
- 2025-11-20：AI 图像页新增模型选择与组织 ID 输入，随请求传递到后端；配合后端支持 `model` 和 `api_org_id` 字段。
- 2025-11-20：为状态标签与地区标签启用文本选择；在 AI 图像页新增“复制状态/复制地区状态”按钮，提升错误信息可复制性与排查效率。
- 2025-11-20：统一禁用 UI 请求代理、支持 `API_BASE_URL` 配置；修复在代理/VPN 环境下对本地端点的访问异常；不影响后端地区策略的判定结果。
- 2025-11-20：AI 标签页新增“地区状态”信息展示与刷新按钮，接入后端策略路由。
- 2025-11-19：新增“AI图像生成”标签页，支持上传图片与提示词并生成输出。
 - 2025-11-19：AI 图像生成标签页增加内嵌预览、打开输出目录与“预览最新输出”功能。
 - 2025-11-19：UI 支持多图选择与右到左缩略图预览；默认窗口为 1280x720。
 - 2025-11-19：AI 标签页缩略图容器改为 16:9 框（最多显示 3 张，超出可横向滑动）；新增“清空已选图片”。新增 API Key 输入与显示/隐藏切换。缩略图顺序修正为左→右（最早→最新）。
- 2025-11-19：风格维护（imports 排序与格式统一），修复 CI isort/black 提示；不改动业务逻辑。
- 2025-11-19：风格维护（isort 导入顺序调整），确保 CI 检查通过；不改动业务逻辑。
- 2025-11-05：启用风格检查（ruff/black/isort）；本目录 Python 文件已按规则格式化，未改变业务逻辑。
- 2025-11-05：UI 按钮已接入后端 HTTP 端点，需先启动 API 服务。