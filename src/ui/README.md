# 用户界面（ui）

此目录包含 PyQt6 应用入口与基础窗口：
- `app.py`：主窗口，包含“空间映射”、“投影标定”、“AI图像生成”标签页。

运行示例：
```powershell
python .\src\ui\app.py
```

使用说明：
- 先启动后端 API 服务：`python -m uvicorn src.server.main:app --reload`。
- UI 按钮通过 HTTP 调用后端端点：
  - “开始映射/停止映射”分别对应 `POST /mapping/start` 与 `POST /mapping/stop`；
  - “开始标定”对应 `POST /calibration/run`；状态信息将在标签页标题处更新。
  - “AI图像生成”上传图片与提示词，调用 `POST /ai-image/edit`，输出路径显示在状态区域；需在 `.env` 配置 `OPENAI_API_KEY`。
- 生成成功后 UI 内直接预览图片，并提供“打开输出目录”按钮快捷查看生成结果文件。
  - 支持“预览最新输出”，无需再次生成，直接显示 `data/ai_images/outputs` 中最近的图片。
  - 支持多图选择并在界面中进行右到左缩略图排布；生成默认使用最近一次选择的图片。
  - 缩略图预览置于 16:9 框中（约 640x360），一次最多可见 3 张，更多图片可通过横向滑条浏览；顺序为左→右：最早在左、最新在右；提供“清空已选图片”按钮。
  - 生成界面新增 OpenAI API Key 输入框（默认以 * 隐藏，右侧按钮可切换显示）；当填写时会随请求一并传递到后端以便即时使用。
 - 新增“地区状态”信息展示与刷新按钮：通过 `GET /policy/region/status` 显示国家/地区代码、城市、是否允许、连通性诊断与原因；仅当地区允许时才可成功调用 OpenAI 相关能力（VPN 以出口 IP 定位为准）。
 - API 基础地址可通过环境变量配置：`API_BASE_URL`（默认 `http://127.0.0.1:8000`）。
 - 为避免 VPN/系统代理拦截本地请求，UI 在所有对后端的 HTTP 请求中已显式禁用代理（`requests` 参数 `proxies={"http": None, "https": None}`）；这不会绕过后端的地区策略判断，仅保证 UI 请求能直接连接到本地服务。
 - 文本选择与复制：所有状态标签（映射/标定/AI 图像）均支持文本文字选择与复制；AI 图像页额外提供“复制状态”“复制地区状态”按钮，方便在出现错误时快速复制文本内容。

窗口尺寸：默认 `1280x720`（16:9）。

更新记录：
- 2025-11-20：为状态标签与地区标签启用文本选择；在 AI 图像页新增“复制状态/复制地区状态”按钮，提升错误信息可复制性与排查效率。
- 2025-11-20：统一禁用 UI 请求代理、支持 `API_BASE_URL` 配置；修复在代理/VPN 环境下对本地端点的访问异常；不影响后端地区策略的判定结果。
- 2025-11-20：AI 标签页新增“地区状态”信息展示与刷新按钮，接入后端策略路由。
- 2025-11-19：新增“AI图像生成”标签页，支持上传图片与提示词并生成输出。
 - 2025-11-19：AI 图像生成标签页增加内嵌预览、打开输出目录与“预览最新输出”功能。
 - 2025-11-19：UI 支持多图选择与右到左缩略图预览；默认窗口为 1280x720。
 - 2025-11-19：AI 标签页缩略图容器改为 16:9 框（最多显示 3 张，超出可横向滑动）；新增“清空已选图片”。新增 API Key 输入与显示/隐藏切换。缩略图顺序修正为左→右（最早→最新）。
- 2025-11-19：风格维护（imports 排序与格式统一），修复 CI isort/black 提示；不改动业务逻辑。
- 2025-11-19：风格维护（isort 导入顺序调整），确保 CI 检查通过；不改动业务逻辑。
- 2025-11-05：启用风格检查（ruff/black/isort）；本目录 Python 文件已按规则格式化，未改变业务逻辑。
- 2025-11-05：UI 按钮已接入后端 HTTP 端点，需先启动 API 服务。