name: CI

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: windows-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install CI dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install fastapi uvicorn pytest httpx pydantic pydantic-settings
          python -m pip install ruff black isort
          # Install optional dependency for AI image module to avoid ImportError during test collection
          python -m pip install openai
          # Install required dependency for FastAPI form/multipart handling
          python -m pip install python-multipart
          # Install HTTP client used by RegionPolicyService (official list fetch)
          python -m pip install requests
      - name: Style checks (ruff/black/isort)
        run: |
          ruff check src tests scripts .trae
          black --check src tests scripts .trae
          isort --profile black --check-only src tests scripts .trae
      - name: Run tests (non-hardware)
        run: |
          python -m pytest -m "not hardware" -q